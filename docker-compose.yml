version: "3.9"
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  app:
    build: .
    environment:
      - APP_PORT=${APP_PORT:-8080}
      - APP_HOST=${APP_HOST:-0.0.0.0}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - BROKER_URL=${BROKER_URL:-redis://redis:6379/1}
      - RESULT_BACKEND=${RESULT_BACKEND:-redis://redis:6379/2}
      - UPLOAD_DIR=${UPLOAD_DIR:-/data/uploads}
      - TRANSCRIPT_DIR=${TRANSCRIPT_DIR:-/data/transcripts}
      - MODEL_PATH=${MODEL_PATH:-/models/ggml-base.bin}
      - ENABLE_GPU=${ENABLE_GPU:-false}
      - GPU_BACKEND=${GPU_BACKEND:-}
      - GPU_DEVICE_ID=${GPU_DEVICE_ID:-0}
      - USE_ESTONIAN_MODEL=${USE_ESTONIAN_MODEL:-true}
      - ESTONIAN_MODEL=${ESTONIAN_MODEL:-TalTechNLP/whisper-large-v3-turbo-et-verbatim}
      - LOCAL_ADMIN_ENABLED=${LOCAL_ADMIN_ENABLED:-true}
      - LOCAL_ADMIN_USERNAME=${LOCAL_ADMIN_USERNAME:-admin}
      - LOCAL_ADMIN_PASSWORD=${LOCAL_ADMIN_PASSWORD:-changeme}
      - LOCAL_ADMIN_EMAIL=${LOCAL_ADMIN_EMAIL:-admin@example.com}
      - OIDC_DISCOVERY_URL
      - OIDC_CLIENT_ID
      - OIDC_CLIENT_SECRET
      - OIDC_AUDIENCE
      - OIDC_ISSUER
      - OIDC_ALLOWED_ALGS
      - ROLE_CLAIM_PATH
      - ROLE_MAPPING_JSON
      - SMTP_HOST
      - SMTP_PORT
      - SMTP_USER
      - SMTP_PASSWORD
      - SMTP_TLS
      - SMTP_FROM
      - PYANNOTE_AUTH_TOKEN
      - PYANNOTE_DIARIZATION_MODEL=${PYANNOTE_DIARIZATION_MODEL:-pyannote/speaker-diarization-3.1}
      - PYANNOTE_LOCAL_PATH=${PYANNOTE_LOCAL_PATH:-}
    ports:
      - "8080:8080"
    depends_on:
      - redis
    volumes:
      - ./data:/data
      - ./models:/models
      - ./app:/app/app
      - ./templates:/app/templates
      - huggingface_cache:/root/.cache/huggingface
  worker:
    build: .
    command: ["celery", "-A", "app.celery_app.celery_app", "worker", "--loglevel=INFO", "-c", "20"]
    environment:
      - BROKER_URL=${BROKER_URL:-redis://redis:6379/1}
      - RESULT_BACKEND=${RESULT_BACKEND:-redis://redis:6379/2}
      - UPLOAD_DIR=${UPLOAD_DIR:-/data/uploads}
      - TRANSCRIPT_DIR=${TRANSCRIPT_DIR:-/data/transcripts}
      - MODEL_PATH=${MODEL_PATH:-/models/ggml-base.bin}
      - ENABLE_GPU=${ENABLE_GPU:-false}
      - GPU_BACKEND=${GPU_BACKEND:-}
      - GPU_DEVICE_ID=${GPU_DEVICE_ID:-0}
      - PYTORCH_NUM_THREADS=${PYTORCH_NUM_THREADS:-20}
      - OMP_NUM_THREADS=${OMP_NUM_THREADS:-20}
      - TOKENIZERS_PARALLELISM=false
      - TORCH_LOAD_SAFE_MODE=1
      - USE_ESTONIAN_MODEL=${USE_ESTONIAN_MODEL:-true}
      - ESTONIAN_MODEL=${ESTONIAN_MODEL:-TalTechNLP/whisper-large-v3-turbo-et-verbatim}
      - PYANNOTE_AUTH_TOKEN
      - PYANNOTE_DIARIZATION_MODEL=${PYANNOTE_DIARIZATION_MODEL:-pyannote/speaker-diarization-3.1}
      - PYANNOTE_LOCAL_PATH=${PYANNOTE_LOCAL_PATH:-}
    depends_on:
      - redis
    volumes:
      - ./data:/data
      - ./models:/models
      - ./app:/app/app
      - ./templates:/app/templates
      - huggingface_cache:/root/.cache/huggingface

volumes:
  huggingface_cache:
  model_cache: