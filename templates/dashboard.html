<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Dashboard - Transcription Service</title>
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
	<header class="bg-white shadow">
		<div class="mx-auto max-w-7xl px-4 py-4 flex justify-between items-center">
			<h1 class="text-xl font-semibold text-gray-800">Transcription Dashboard</h1>
			<button id="logout" class="text-sm text-gray-600 hover:text-gray-900">Logout</button>
		</div>
	</header>
	<main class="mx-auto max-w-3xl p-4">
		<section class="bg-white shadow rounded-lg p-6 mt-6">
			<h2 class="text-lg font-medium text-gray-800 mb-4">Upload Video</h2>
			<form id="upload-form" class="space-y-4">
				<input id="video" type="file" accept="video/*" class="block w-full" required />
				<button type="submit" class="inline-flex justify-center rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">Upload</button>
			</form>
			<div class="mt-4">
				<label class="text-sm text-gray-600">Upload progress</label>
				<div class="w-full bg-gray-200 rounded h-3"><div id="pb-upload" class="bg-indigo-600 h-3 rounded" style="width:0%"></div></div>
			</div>
			<p id="upload-status" class="text-sm text-gray-600 mt-2"></p>
		</section>

		<section class="bg-white shadow rounded-lg p-6 mt-6">
			<h2 class="text-lg font-medium text-gray-800 mb-4">Recent Jobs</h2>
			<ul id="jobs" class="space-y-4 text-sm text-gray-700"></ul>
		</section>
	</main>
	<script>
	const token = localStorage.getItem('token');
	if (!token) { window.location.href = '/login'; }

	document.getElementById('logout').addEventListener('click', () => {
		localStorage.removeItem('token');
		window.location.href = '/login';
	});

	const uploadForm = document.getElementById('upload-form');
	const uploadStatus = document.getElementById('upload-status');
	const jobsEl = document.getElementById('jobs');
	const pbUpload = document.getElementById('pb-upload');

	uploadForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const fileInput = document.getElementById('video');
		const file = fileInput.files[0];
		const fd = new FormData();
		fd.append('file', file);
		uploadStatus.textContent = 'Uploading...';
		pbUpload.style.width = '0%';
		try {
			const res = await fetch('/api/upload', {
				method: 'POST',
				headers: { 'Authorization': 'Bearer ' + token },
				body: fd
			});
			if (!res.ok) throw new Error('Upload failed');
			const data = await res.json();
			uploadStatus.textContent = 'Job ' + data.job_id + ' queued.';
			pbUpload.style.width = '100%';
			addJob(data.job_id);
		} catch (err) {
			uploadStatus.textContent = err.message;
		}
	});

	function progressBar(id) {
		return `<div class="space-y-2">
			<div>
				<label class="text-xs text-gray-600">Transcription</label>
				<div class="w-full bg-gray-200 rounded h-2"><div id="pb-tr-${id}" class="bg-indigo-600 h-2 rounded" style="width:0%"></div></div>
			</div>
			<div>
				<label class="text-xs text-gray-600">Summarization</label>
				<div class="w-full bg-gray-200 rounded h-2"><div id="pb-su-${id}" class="bg-green-600 h-2 rounded" style="width:0%"></div></div>
			</div>
		</div>`;
	}

	function addJob(jobId) {
		const li = document.createElement('li');
		li.dataset.jobId = jobId;
		li.className = 'border rounded p-4';
		li.innerHTML = `<div class="flex justify-between items-center">
			<span class="font-medium">Job: ${jobId}</span>
			<div class="space-x-2">
				<button data-action="status" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">Status</button>
				<a data-action="txt" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200" href="#">TXT</a>
				<a data-action="json" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200" href="#">JSON</a>
				<a data-action="summary" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200" href="#">Summary</a>
			</div>
		</div>
		<div class="mt-3">${progressBar(jobId)}</div>`;
		jobsEl.prepend(li);
		poll(jobId);
	}

	async function poll(jobId) {
		const tr = document.getElementById('pb-tr-' + jobId);
		const su = document.getElementById('pb-su-' + jobId);
		let done = false;
		while (!done) {
			await new Promise(r => setTimeout(r, 2000));
			const res = await fetch('/api/status/' + jobId, { headers: { 'Authorization': 'Bearer ' + token } });
			if (!res.ok) break;
			const data = await res.json();
			if (data.stage === 'transcribe') {
				tr.style.width = Math.max(10, data.percent) + '%';
			} else if (data.stage === 'summarize' || data.stage === 'diarize') {
				tr.style.width = '80%';
				su.style.width = '30%';
			} else if (data.stage === 'done') {
				tr.style.width = '100%';
				su.style.width = '100%';
				done = true;
			}
		}
	}

	jobsEl.addEventListener('click', async (e) => {
		const btn = e.target.closest('button, a');
		if (!btn) return;
		const li = btn.closest('li');
		const jobId = li.dataset.jobId;
		const action = btn.dataset.action;
		if (action === 'status') {
			const res = await fetch('/api/status/' + jobId, { headers: { 'Authorization': 'Bearer ' + token } });
			if (res.ok) {
				const data = await res.json();
				alert('Status: ' + data.status + ' (' + (data.percent ?? 0) + '%)');
			}
		} else if (action === 'txt' || action === 'json' || action === 'summary') {
			const fmt = action === 'summary' ? 'summary' : action;
			const res = await fetch('/api/transcript/' + jobId + '?format=' + fmt, { headers: { 'Authorization': 'Bearer ' + token } });
			if (res.ok) {
				const blob = await res.blob();
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `transcript_${jobId}.${fmt === 'json' ? 'json' : (fmt === 'summary' ? 'summary.txt' : 'txt')}`;
				a.click();
				URL.revokeObjectURL(url);
			}
		}
	});
	</script>
</body>
</html>
