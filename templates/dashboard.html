<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Dashboard - Transcription Service</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			darkMode: 'class',
			theme: {
				extend: {
					colors: {
						dark: {
							50: '#f8fafc',
							100: '#f1f5f9',
							200: '#e2e8f0',
							300: '#cbd5e1',
							400: '#94a3b8',
							500: '#64748b',
							600: '#475569',
							700: '#334155',
							800: '#1e293b',
							900: '#0f172a',
						}
					}
				}
			}
		}
	</script>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-dark-900 transition-colors duration-200">
	<header class="bg-white dark:bg-dark-800 shadow-lg transition-colors duration-200">
        <div class="mx-auto max-w-7xl px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-semibold text-gray-800 dark:text-dark-100">Transcription Dashboard</h1>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="p-2 rounded-lg bg-gray-100 dark:bg-dark-700 hover:bg-gray-200 dark:hover:bg-dark-600 transition-colors duration-200">
                    <svg id="sun-icon" class="w-5 h-5 text-gray-600 dark:text-dark-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg id="moon-icon" class="w-5 h-5 text-gray-600 dark:text-dark-300 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
                <span class="text-sm text-gray-600 dark:text-dark-300" id="username"></span>
                <button id="logout" class="text-sm text-gray-600 dark:text-dark-300 hover:text-gray-900 dark:hover:text-dark-100 transition-colors duration-200">Logout</button>
            </div>
        </div>
	</header>
	<main class="flex h-screen pt-16">
		<!-- Left Pane: Upload and Controls -->
		<div class="w-1/2 p-6 overflow-y-auto">
			<!-- Upload Section -->
			<section class="bg-white dark:bg-dark-800 shadow-lg rounded-lg p-6 mb-6 transition-colors duration-200">
				<h2 class="text-lg font-medium text-gray-800 dark:text-dark-100 mb-4">Upload Video</h2>
				<form id="upload-form" class="space-y-4">
					<div id="drop-zone" class="border-2 border-dashed border-gray-300 dark:border-dark-600 rounded-lg p-6 text-center hover:border-indigo-400 dark:hover:border-indigo-500 transition-colors duration-200">
						<input id="video" type="file" accept="video/*" multiple class="hidden" />
						<label for="video" class="cursor-pointer">
							<svg class="mx-auto h-12 w-12 text-gray-400 dark:text-dark-500" stroke="currentColor" fill="none" viewBox="0 0 48 48">
								<path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
							</svg>
							<p class="mt-2 text-sm text-gray-600 dark:text-dark-400">Click to select video files or drag & drop here</p>
							<p class="text-xs text-gray-500 dark:text-dark-500 mt-1">Supports multiple files</p>
						</label>
					</div>
					<div id="file-list" class="hidden space-y-2"></div>
					<button type="submit" class="w-full inline-flex justify-center items-center rounded-md bg-indigo-600 hover:bg-indigo-700 px-4 py-2 text-white transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed" id="upload-btn">
						<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
						</svg>
						Upload Video
					</button>
				</form>
				<div class="mt-4">
					<label class="text-sm text-gray-600 dark:text-dark-400">Upload progress</label>
					<div class="w-full bg-gray-200 dark:bg-dark-700 rounded h-3 mt-1">
						<div id="pb-upload" class="bg-indigo-600 h-3 rounded transition-all duration-300" style="width:0%"></div>
					</div>
				</div>
				<p id="upload-status" class="text-sm text-gray-600 dark:text-dark-400 mt-2"></p>
			</section>

			<!-- Clear All Section -->
			<section class="bg-white dark:bg-dark-800 shadow-lg rounded-lg p-6 mb-6 transition-colors duration-200">
				<h2 class="text-lg font-medium text-gray-800 dark:text-dark-100 mb-4">Manage Transcripts</h2>
				<button id="clear-all-btn" class="w-full inline-flex justify-center items-center rounded-md bg-red-600 hover:bg-red-700 px-4 py-2 text-white transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
					<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
					</svg>
					Clear All Transcripts
				</button>
				<p class="text-sm text-gray-500 dark:text-dark-400 mt-2">This will permanently delete all your transcripts and cannot be undone.</p>
			</section>

			<!-- Search Section -->
			<section class="bg-white dark:bg-dark-800 shadow-lg rounded-lg p-6 mb-6 transition-colors duration-200">
				<h2 class="text-lg font-medium text-gray-800 dark:text-dark-100 mb-4">Search Transcripts</h2>
				<div class="flex space-x-2">
					<input id="search-input" type="text" placeholder="Search across all transcripts..." 
						class="flex-1 px-3 py-2 border border-gray-300 dark:border-dark-600 rounded-md bg-white dark:bg-dark-700 text-gray-900 dark:text-dark-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
					<button id="search-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors duration-200">
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
						</svg>
					</button>
					<button id="clear-search-btn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors duration-200">
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
						</svg>
					</button>
				</div>
				<div id="search-results" class="mt-4 hidden"></div>
			</section>

			<!-- Analytics Section -->
			<section class="bg-white dark:bg-dark-800 shadow-lg rounded-lg p-6 mb-6 transition-colors duration-200">
				<div class="flex items-center justify-between mb-4">
					<h2 class="text-lg font-medium text-gray-800 dark:text-dark-100">Analytics</h2>
					<button id="refresh-analytics" class="text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300">
						Refresh
					</button>
				</div>
				<div id="analytics-content" class="grid grid-cols-2 gap-4 text-sm">
					<div class="bg-gray-50 dark:bg-dark-700 p-3 rounded">
						<div class="text-gray-600 dark:text-dark-400">Total Transcripts</div>
						<div id="total-transcripts" class="text-xl font-semibold text-gray-900 dark:text-dark-100">-</div>
					</div>
					<div class="bg-gray-50 dark:bg-dark-700 p-3 rounded">
						<div class="text-gray-600 dark:text-dark-400">Total Duration</div>
						<div id="total-duration" class="text-xl font-semibold text-gray-900 dark:text-dark-100">-</div>
					</div>
					<div class="bg-gray-50 dark:bg-dark-700 p-3 rounded">
						<div class="text-gray-600 dark:text-dark-400">Storage Used</div>
						<div id="storage-used" class="text-xl font-semibold text-gray-900 dark:text-dark-100">-</div>
					</div>
					<div class="bg-gray-50 dark:bg-dark-700 p-3 rounded">
						<div class="text-gray-600 dark:text-dark-400">Languages</div>
						<div id="languages" class="text-xl font-semibold text-gray-900 dark:text-dark-100">-</div>
					</div>
				</div>
			</section>

			<!-- Jobs Section -->
			<section class="bg-white dark:bg-dark-800 shadow-lg rounded-lg p-6 transition-colors duration-200">
				<h2 class="text-lg font-medium text-gray-800 dark:text-dark-100 mb-4">Recent Jobs</h2>
				<ul id="jobs" class="space-y-4 text-sm text-gray-700 dark:text-dark-300"></ul>
			</section>
		</div>

		<!-- Right Pane: Live Logs -->
		<div class="w-1/2 border-l border-gray-200 dark:border-dark-700 p-6 overflow-y-auto">
			<section class="bg-white dark:bg-dark-800 shadow-lg rounded-lg p-6 h-full transition-colors duration-200">
				<div class="flex items-center justify-between mb-4">
					<h3 class="text-lg font-medium text-gray-800 dark:text-dark-100">Live Logs</h3>
					<button id="clear-logs" class="text-sm text-gray-500 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-200 transition-colors duration-200">
						Clear
					</button>
				</div>
				<pre id="live-logs" class="h-full overflow-auto bg-gray-50 dark:bg-dark-900 p-4 rounded text-xs text-gray-800 dark:text-dark-200 font-mono whitespace-pre-wrap"></pre>
			</section>
		</div>
	</main>
	<script>
    const token = localStorage.getItem('token');
	if (!token) { window.location.href = '/login'; }
    
    // Dark mode functionality
    const themeToggle = document.getElementById('theme-toggle');
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');
    const html = document.documentElement;
    
    // Load saved theme or default to light
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
        html.classList.add('dark');
        sunIcon.classList.add('hidden');
        moonIcon.classList.remove('hidden');
    }
    
    themeToggle.addEventListener('click', () => {
        html.classList.toggle('dark');
        const isDark = html.classList.contains('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        sunIcon.classList.toggle('hidden', isDark);
        moonIcon.classList.toggle('hidden', !isDark);
    });
    
    // Clear logs functionality
    document.getElementById('clear-logs').addEventListener('click', () => {
        document.getElementById('live-logs').textContent = '';
    });
    
    // Search functionality
    document.getElementById('search-btn').addEventListener('click', performSearch);
    document.getElementById('clear-search-btn').addEventListener('click', clearSearch);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch();
    });
    
    async function performSearch() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) return;
        
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.classList.remove('hidden');
        resultsDiv.innerHTML = '<div class="text-center py-4">Searching...</div>';
        
        try {
            const res = await fetch(`/api/search?query=${encodeURIComponent(query)}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            displaySearchResults(data);
        } catch (err) {
            resultsDiv.innerHTML = '<div class="text-red-600">Search failed: ' + err.message + '</div>';
        }
    }
    
    function clearSearch() {
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').classList.add('hidden');
    }
    
    function displaySearchResults(data) {
        const resultsDiv = document.getElementById('search-results');
        
        if (data.results.length === 0) {
            resultsDiv.innerHTML = '<div class="text-gray-500">No results found</div>';
            return;
        }
        
        let html = `<div class="text-sm text-gray-600 dark:text-dark-400 mb-3">Found ${data.results.length} result(s)</div>`;
        
        data.results.forEach(result => {
            const displayName = result.filename || `Job: ${result.job_id}`;
            html += `
                <div class="border border-gray-200 dark:border-dark-600 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex flex-col">
                            <h3 class="font-medium text-gray-800 dark:text-dark-100">${displayName}</h3>
                            <span class="text-xs text-gray-500 dark:text-dark-400">${result.job_id}</span>
                        </div>
                        <span class="text-xs text-gray-500 dark:text-dark-400">${result.language} • ${result.total_segments} segments</span>
                    </div>
                    <div class="space-y-2">
            `;
            
            result.segments.slice(0, 3).forEach(segment => {
                const time = `[${segment.start?.toFixed(1)}s - ${segment.end?.toFixed(1)}s]`;
                const speaker = segment.speaker ? `[${segment.speaker}]` : '';
                html += `<div class="text-sm text-gray-700 dark:text-dark-300">${time} ${speaker} ${segment.text}</div>`;
            });
            
            if (result.segments.length > 3) {
                html += `<div class="text-xs text-gray-500">... and ${result.segments.length - 3} more matches</div>`;
            }
            
            html += '</div></div>';
        });
        
        resultsDiv.innerHTML = html;
    }
    
    // Analytics functionality
    document.getElementById('refresh-analytics').addEventListener('click', loadAnalytics);
    loadAnalytics(); // Load on page load
    
    // Load existing jobs on page load
    loadExistingJobs();
    
    async function loadAnalytics() {
        try {
            const res = await fetch('/api/analytics', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            
            document.getElementById('total-transcripts').textContent = data.total_transcripts;
            document.getElementById('total-duration').textContent = data.total_duration_hours.toFixed(1) + 'h';
            document.getElementById('storage-used').textContent = data.storage_used_mb.toFixed(1) + 'MB';
            
            const languages = Object.entries(data.language_distribution)
                .map(([lang, count]) => `${lang}: ${count}`)
                .join(', ');
            document.getElementById('languages').textContent = languages || 'None';
        } catch (err) {
            console.error('Failed to load analytics:', err);
        }
    }
    
    async function loadExistingJobs() {
        try {
            const res = await fetch('/api/jobs', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                const jobs = await res.json();
                jobs.forEach(job => {
                    addJob(job.job_id, job.filename, job.status);
                });
            }
        } catch (err) {
            console.error('Failed to load existing jobs:', err);
        }
    }
    
    // File selection feedback
    document.getElementById('video').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const label = document.querySelector('label[for="video"] p');
        if (file) {
            label.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB)`;
            label.className = 'mt-2 text-sm text-green-600 dark:text-green-400';
        } else {
            label.textContent = 'Click to select video file';
            label.className = 'mt-2 text-sm text-gray-600 dark:text-dark-400';
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + U to focus upload
        if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
            e.preventDefault();
            document.getElementById('video').click();
        }
        // Ctrl/Cmd + K to clear logs
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('clear-logs').click();
        }
        // Escape to clear selection
        if (e.key === 'Escape') {
            document.getElementById('video').value = '';
            document.querySelector('label[for="video"] p').textContent = 'Click to select video file';
            document.querySelector('label[for="video"] p').className = 'mt-2 text-sm text-gray-600 dark:text-dark-400';
        }
    });
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // decode username from token (HS256 local token has email/name)
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        document.getElementById('username').textContent = payload.name || payload.email || '';
    } catch {}

	document.getElementById('logout').addEventListener('click', () => {
		localStorage.removeItem('token');
		window.location.href = '/login';
	});

	// Clear all transcripts functionality
	document.getElementById('clear-all-btn').addEventListener('click', async () => {
		// Show confirmation modal
		const confirmed = await showClearConfirmation();
		if (!confirmed) return;

		const clearBtn = document.getElementById('clear-all-btn');
		const originalText = clearBtn.innerHTML;
		
		try {
			// Disable button and show loading
			clearBtn.disabled = true;
			clearBtn.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Clearing...';
			
			const response = await fetch('/api/transcripts/clear', {
				method: 'DELETE',
				headers: {
					'Authorization': `Bearer ${localStorage.getItem('token')}`
				}
			});
			
			if (!response.ok) {
				throw new Error('Failed to clear transcripts');
			}
			
			const result = await response.json();
			
			// Show success message
			showNotification(`Successfully deleted ${result.deleted_count} transcript files`, 'success');
			
			// Reload jobs list
			loadExistingJobs();
			
		} catch (error) {
			showNotification('Error clearing transcripts: ' + error.message, 'error');
		} finally {
			// Re-enable button
			clearBtn.disabled = false;
			clearBtn.innerHTML = originalText;
		}
	});

	// Confirmation modal function
	function showClearConfirmation() {
		return new Promise((resolve) => {
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
			modal.innerHTML = `
				<div class="bg-white dark:bg-dark-800 rounded-lg p-6 max-w-md w-full mx-4">
					<div class="flex items-center mb-4">
						<svg class="w-6 h-6 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
						</svg>
						<h3 class="text-lg font-medium text-gray-900 dark:text-dark-100">Clear All Transcripts</h3>
					</div>
					<p class="text-sm text-gray-600 dark:text-dark-400 mb-6">
						This will permanently delete all your transcripts, summaries, and exported files. This action cannot be undone.
					</p>
					<div class="flex space-x-3">
						<button id="confirm-clear" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition-colors duration-200">
							Yes, Delete All
						</button>
						<button id="cancel-clear" class="flex-1 bg-gray-300 hover:bg-gray-400 dark:bg-dark-600 dark:hover:bg-dark-500 text-gray-700 dark:text-dark-200 px-4 py-2 rounded-md transition-colors duration-200">
							Cancel
						</button>
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
			
			modal.querySelector('#confirm-clear').addEventListener('click', () => {
				document.body.removeChild(modal);
				resolve(true);
			});
			
			modal.querySelector('#cancel-clear').addEventListener('click', () => {
				document.body.removeChild(modal);
				resolve(false);
			});
			
			// Close on backdrop click
			modal.addEventListener('click', (e) => {
				if (e.target === modal) {
					document.body.removeChild(modal);
					resolve(false);
				}
			});
		});
	}

	// Notification function
	function showNotification(message, type = 'info') {
		const notification = document.createElement('div');
		notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
			type === 'success' ? 'bg-green-500 text-white' :
			type === 'error' ? 'bg-red-500 text-white' :
			'bg-blue-500 text-white'
		}`;
		notification.textContent = message;
		
		document.body.appendChild(notification);
		
		setTimeout(() => {
			if (document.body.contains(notification)) {
				document.body.removeChild(notification);
			}
		}, 5000);
	}

	const uploadForm = document.getElementById('upload-form');
	const uploadStatus = document.getElementById('upload-status');
	const jobsEl = document.getElementById('jobs');
	const pbUpload = document.getElementById('pb-upload');

	// Drag & Drop functionality
	const dropZone = document.getElementById('drop-zone');
	
	['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
		dropZone.addEventListener(eventName, preventDefaults, false);
	});
	
	function preventDefaults(e) {
		e.preventDefault();
		e.stopPropagation();
	}
	
	['dragenter', 'dragover'].forEach(eventName => {
		dropZone.addEventListener(eventName, highlight, false);
	});
	
	['dragleave', 'drop'].forEach(eventName => {
		dropZone.addEventListener(eventName, unhighlight, false);
	});
	
	function highlight(e) {
		dropZone.classList.add('border-indigo-400', 'bg-indigo-50', 'dark:bg-indigo-900');
	}
	
	function unhighlight(e) {
		dropZone.classList.remove('border-indigo-400', 'bg-indigo-50', 'dark:bg-indigo-900');
	}
	
	dropZone.addEventListener('drop', handleDrop, false);
	
	function handleDrop(e) {
		const dt = e.dataTransfer;
		const files = dt.files;
		handleFiles(files);
	}
	
	// File selection handling
	document.getElementById('video').addEventListener('change', (e) => {
		handleFiles(e.target.files);
	});
	
	function handleFiles(files) {
		const fileList = document.getElementById('file-list');
		const label = document.querySelector('label[for="video"] p');
		
		if (files.length === 0) {
			fileList.classList.add('hidden');
			label.textContent = 'Click to select video files or drag & drop here';
			label.className = 'mt-2 text-sm text-gray-600 dark:text-dark-400';
			return;
		}
		
		fileList.classList.remove('hidden');
		fileList.innerHTML = '';
		
		Array.from(files).forEach((file, index) => {
			const fileItem = document.createElement('div');
			fileItem.className = 'flex items-center justify-between p-2 bg-gray-50 dark:bg-dark-700 rounded text-sm';
			fileItem.innerHTML = `
				<div class="flex items-center">
					<svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
					</svg>
					<span class="text-gray-700 dark:text-dark-300">${file.name}</span>
					<span class="text-gray-500 dark:text-dark-400 ml-2">(${(file.size / 1024 / 1024).toFixed(1)} MB)</span>
				</div>
				<button type="button" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" onclick="removeFile(${index})">
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
					</svg>
				</button>
			`;
			fileList.appendChild(fileItem);
		});
		
		label.textContent = `${files.length} file(s) selected`;
		label.className = 'mt-2 text-sm text-green-600 dark:text-green-400';
	}
	
	// Remove file function
	window.removeFile = function(index) {
		const fileInput = document.getElementById('video');
		const files = Array.from(fileInput.files);
		files.splice(index, 1);
		
		// Create new FileList (simplified approach)
		const dt = new DataTransfer();
		files.forEach(file => dt.items.add(file));
		fileInput.files = dt.files;
		
		handleFiles(fileInput.files);
	};

	uploadForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const fileInput = document.getElementById('video');
		const files = Array.from(fileInput.files);
		const uploadBtn = document.getElementById('upload-btn');
		
		if (files.length === 0) {
			uploadStatus.textContent = 'Please select at least one file';
			uploadStatus.className = 'text-sm text-red-600 dark:text-red-400 mt-2';
			return;
		}
		
		// Disable upload button and show loading state
		uploadBtn.disabled = true;
		uploadBtn.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Uploading...';
		
		uploadStatus.textContent = `Uploading ${files.length} file(s)...`;
		pbUpload.style.width = '0%';
		
		try {
			const jobIds = [];
			for (let i = 0; i < files.length; i++) {
				const file = files[i];
				const fd = new FormData();
				fd.append('file', file);
				
				const res = await fetch('/api/upload', {
					method: 'POST',
					headers: { 'Authorization': 'Bearer ' + token },
					body: fd
				});
				
				if (!res.ok) throw new Error(`Upload failed for ${file.name}`);
				const data = await res.json();
				jobIds.push(data.job_id);
				addJob(data.job_id, file.name, 'processing');
				
				// Update progress
				const progress = ((i + 1) / files.length) * 100;
				pbUpload.style.width = progress + '%';
			}
			
			uploadStatus.textContent = `Successfully queued ${jobIds.length} job(s)`;
			uploadStatus.className = 'text-sm text-green-600 dark:text-green-400 mt-2';
			
			// Reset form
			fileInput.value = '';
			document.getElementById('file-list').classList.add('hidden');
			document.querySelector('label[for="video"] p').textContent = 'Click to select video files or drag & drop here';
			document.querySelector('label[for="video"] p').className = 'mt-2 text-sm text-gray-600 dark:text-dark-400';
			
		} catch (err) {
			uploadStatus.textContent = 'Error: ' + err.message;
			uploadStatus.className = 'text-sm text-red-600 dark:text-red-400 mt-2';
		} finally {
			// Re-enable upload button
			uploadBtn.disabled = false;
			uploadBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>Upload Videos';
		}
	});

	function progressBar(id) {
		return `<div class="space-y-2">
			<div>
				<label class="text-xs text-gray-600 dark:text-dark-400">Transcription</label>
				<div class="w-full bg-gray-200 dark:bg-dark-700 rounded h-2"><div id="pb-tr-${id}" class="bg-indigo-600 h-2 rounded transition-all duration-300" style="width:0%"></div></div>
			</div>
			<div>
				<label class="text-xs text-gray-600 dark:text-dark-400">Summarization</label>
				<div class="w-full bg-gray-200 dark:bg-dark-700 rounded h-2"><div id="pb-su-${id}" class="bg-green-600 h-2 rounded transition-all duration-300" style="width:0%"></div></div>
			</div>
		</div>`;
	}

    function addJob(jobId, filename = null, status = 'processing') {
		const li = document.createElement('li');
		li.dataset.jobId = jobId;
		li.className = 'border border-gray-200 dark:border-dark-700 rounded-lg p-4 bg-white dark:bg-dark-800 transition-colors duration-200';
		
		const displayName = filename ? filename : `Job: ${jobId}`;
		const isCompleted = status === 'completed';
		
		li.innerHTML = `<div class="flex justify-between items-center">
			<div class="flex flex-col">
				<span class="font-medium text-gray-800 dark:text-dark-100">${displayName}</span>
				<span class="text-xs text-gray-500 dark:text-dark-400">${jobId}</span>
			</div>
			<div class="space-x-2">
				<button data-action="edit-speakers" class="px-3 py-1 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors duration-200 ${isCompleted ? '' : 'disabled:opacity-50 disabled:cursor-not-allowed'}" ${isCompleted ? '' : 'disabled'}>Edit Speakers</button>
				<button data-action="txt" class="px-3 py-1 bg-gray-100 dark:bg-dark-700 text-gray-700 dark:text-dark-300 rounded hover:bg-gray-200 dark:hover:bg-dark-600 transition-colors duration-200 ${isCompleted ? '' : 'disabled:opacity-50 disabled:cursor-not-allowed'}" ${isCompleted ? '' : 'disabled'}>TXT</button>
				<button data-action="json" class="px-3 py-1 bg-gray-100 dark:bg-dark-700 text-gray-700 dark:text-dark-300 rounded hover:bg-gray-200 dark:hover:bg-dark-600 transition-colors duration-200 ${isCompleted ? '' : 'disabled:opacity-50 disabled:cursor-not-allowed'}" ${isCompleted ? '' : 'disabled'}>JSON</button>
				<button data-action="summary" class="px-3 py-1 bg-gray-100 dark:bg-dark-700 text-gray-700 dark:text-dark-300 rounded hover:bg-gray-200 dark:hover:bg-dark-600 transition-colors duration-200 ${isCompleted ? '' : 'disabled:opacity-50 disabled:cursor-not-allowed'}" ${isCompleted ? '' : 'disabled'}>Summary</button>
				<div class="flex space-x-1">
					<button data-action="pdf" class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-800 transition-colors duration-200 ${isCompleted ? '' : 'disabled:opacity-50 disabled:cursor-not-allowed'}" ${isCompleted ? '' : 'disabled'}>PDF</button>
					<button data-action="docx" class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors duration-200 ${isCompleted ? '' : 'disabled:opacity-50 disabled:cursor-not-allowed'}" ${isCompleted ? '' : 'disabled'}>DOCX</button>
					<button data-action="pptx" class="px-2 py-1 bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors duration-200 ${isCompleted ? '' : 'disabled:opacity-50 disabled:cursor-not-allowed'}" ${isCompleted ? '' : 'disabled'}>PPTX</button>
				</div>
			</div>
		</div>
		<div class="mt-3">${progressBar(jobId)}</div>`;
		jobsEl.prepend(li);
		
		if (status === 'processing') {
			poll(jobId);
		}
        pollLogs(jobId);
	}

	async function poll(jobId) {
		const tr = document.getElementById('pb-tr-' + jobId);
		const su = document.getElementById('pb-su-' + jobId);
		const li = document.querySelector(`[data-job-id="${jobId}"]`);
		const buttons = li.querySelectorAll('button[data-action="txt"], button[data-action="json"], button[data-action="summary"]');
		let done = false;
		while (!done) {
			await new Promise(r => setTimeout(r, 2000));
			const res = await fetch('/api/status/' + jobId, { headers: { 'Authorization': 'Bearer ' + token } });
			if (!res.ok) break;
			const data = await res.json();
			if (data.stage === 'transcribe') {
				tr.style.width = Math.max(10, data.percent) + '%';
			} else if (data.stage === 'summarize' || data.stage === 'diarize') {
				tr.style.width = '100%';
				su.style.width = Math.max(30, data.percent) + '%';
				// Enable buttons when transcription is complete
				buttons.forEach(btn => {
					btn.disabled = false;
					btn.classList.remove('opacity-50', 'cursor-not-allowed');
					btn.classList.add('hover:bg-gray-200', 'dark:hover:bg-dark-600');
				});
				
				// Also enable export and edit buttons
				const otherButtons = li.querySelectorAll('button[data-action="pdf"], button[data-action="docx"], button[data-action="pptx"], button[data-action="edit-speakers"]');
				otherButtons.forEach(btn => {
					btn.disabled = false;
					btn.classList.remove('opacity-50', 'cursor-not-allowed');
				});
			} else if (data.stage === 'done') {
				tr.style.width = '100%';
				su.style.width = '100%';
				done = true;
				
				// Enable all buttons when job is complete
				buttons.forEach(btn => {
					btn.disabled = false;
					btn.classList.remove('opacity-50', 'cursor-not-allowed');
					btn.classList.add('hover:bg-gray-200', 'dark:hover:bg-dark-600');
				});
				
				// Also enable export and edit buttons
				const otherButtons = li.querySelectorAll('button[data-action="pdf"], button[data-action="docx"], button[data-action="pptx"], button[data-action="edit-speakers"]');
				otherButtons.forEach(btn => {
					btn.disabled = false;
					btn.classList.remove('opacity-50', 'cursor-not-allowed');
				});
				
				// Send notification when job is complete
				if ('Notification' in window && Notification.permission === 'granted') {
					new Notification('Transcription Complete', {
						body: `Job ${jobId} has finished processing`,
						icon: '/favicon.ico'
					});
				}
			}
		}
	}

	// Global variable to track current active job for logs
	let currentActiveJobId = null;
	let logPollingInterval = null;

	async function pollLogs(jobId) {
		// Stop any existing polling
		if (logPollingInterval) {
			clearInterval(logPollingInterval);
		}
		
		currentActiveJobId = jobId;
		const logsEl = document.getElementById('live-logs');
		
		// Poll logs for the current job
		logPollingInterval = setInterval(async () => {
			if (currentActiveJobId !== jobId) {
				clearInterval(logPollingInterval);
				return;
			}
			
			try {
				const res = await fetch('/api/logs/' + jobId, { headers: { 'Authorization': 'Bearer ' + token } });
				if (!res.ok) {
					clearInterval(logPollingInterval);
					return;
				}
				const text = await res.text();
				logsEl.textContent = text;
				logsEl.scrollTop = logsEl.scrollHeight;
			} catch (err) {
				console.error('Error polling logs:', err);
				clearInterval(logPollingInterval);
			}
		}, 2000);
	}

	jobsEl.addEventListener('click', async (e) => {
		const btn = e.target.closest('button, a');
		if (!btn) return;
		const li = btn.closest('li');
		const jobId = li.dataset.jobId;
		const action = btn.dataset.action;
		if (action === 'status') {
			const res = await fetch('/api/status/' + jobId, { headers: { 'Authorization': 'Bearer ' + token } });
			if (res.ok) {
				const data = await res.json();
				alert('Status: ' + data.status + ' (' + (data.percent ?? 0) + '%)');
			}
		} else if (action === 'txt' || action === 'json' || action === 'summary') {
			const fmt = action === 'summary' ? 'summary' : action;
			const res = await fetch('/api/transcript/' + jobId + '?format=' + fmt, { headers: { 'Authorization': 'Bearer ' + token } });
			if (res.ok) {
				const blob = await res.blob();
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `transcript_${jobId}.${fmt === 'json' ? 'json' : (fmt === 'summary' ? 'summary.txt' : 'txt')}`;
				a.click();
				URL.revokeObjectURL(url);
			}
		} else if (action === 'pdf' || action === 'docx' || action === 'pptx') {
			const res = await fetch('/api/export/' + jobId + '?format=' + action, { headers: { 'Authorization': 'Bearer ' + token } });
			if (res.ok) {
				const blob = await res.blob();
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `transcript_${jobId}.${action}`;
				a.click();
				URL.revokeObjectURL(url);
			} else {
				alert('Export failed: ' + (await res.text()));
			}
		} else if (action === 'edit-speakers') {
			await editSpeakers(jobId);
		}
	});
	
	// Speaker editing functionality
	async function editSpeakers(jobId) {
		try {
			// Get current transcript data
			const res = await fetch('/api/transcript/' + jobId + '?format=json', { 
				headers: { 'Authorization': 'Bearer ' + token } 
			});
			if (!res.ok) throw new Error('Failed to load transcript');
			
			const data = await res.json();
			const segments = data.segments || [];
			
			// Extract unique speakers
			const speakers = [...new Set(segments.map(s => s.speaker).filter(s => s))];
			
			// Create modal for speaker editing
			const modal = document.createElement('div');
			modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
			modal.innerHTML = `
				<div class="bg-white dark:bg-dark-800 rounded-lg p-6 max-w-md w-full mx-4">
					<h3 class="text-lg font-medium text-gray-800 dark:text-dark-100 mb-4">Edit Speaker Names</h3>
					<div id="speaker-inputs" class="space-y-3 mb-4"></div>
					<div class="flex space-x-2">
						<button id="save-speakers" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save</button>
						<button id="cancel-speakers" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
			
			// Add input fields for each speaker
			const inputsDiv = document.getElementById('speaker-inputs');
			speakers.forEach(speaker => {
				const div = document.createElement('div');
				div.className = 'flex items-center space-x-2';
				div.innerHTML = `
					<label class="text-sm text-gray-600 dark:text-dark-400 w-20">${speaker}:</label>
					<input type="text" value="${speaker}" data-original="${speaker}" 
						class="flex-1 px-2 py-1 border border-gray-300 dark:border-dark-600 rounded bg-white dark:bg-dark-700 text-gray-900 dark:text-dark-100">
				`;
				inputsDiv.appendChild(div);
			});
			
			// Handle save
			document.getElementById('save-speakers').addEventListener('click', async () => {
				const inputs = modal.querySelectorAll('input[data-original]');
				const speakerMap = {};
				
				inputs.forEach(input => {
					const original = input.dataset.original;
					const newName = input.value.trim();
					if (newName && newName !== original) {
						speakerMap[original] = newName;
					}
				});
				
				if (Object.keys(speakerMap).length > 0) {
					const updateRes = await fetch('/api/transcript/' + jobId + '/speakers', {
						method: 'PUT',
						headers: { 
							'Authorization': 'Bearer ' + token,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(speakerMap)
					});
					
					if (updateRes.ok) {
						alert('Speaker names updated successfully!');
						// Refresh the page to show updated names
						location.reload();
					} else {
						alert('Failed to update speaker names');
					}
				}
				
				document.body.removeChild(modal);
			});
			
			// Handle cancel
			document.getElementById('cancel-speakers').addEventListener('click', () => {
				document.body.removeChild(modal);
			});
			
		} catch (err) {
			alert('Error: ' + err.message);
		}
	}
	</script>
</body>
</html>
